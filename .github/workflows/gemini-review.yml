name: Gemini File-based Review and Commit

on:
  push:
    # å…¨ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¾ã™ã€‚
    # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®ãƒ—ãƒƒã‚·ãƒ¥å…ˆã¯ ${{ github.ref_name }} ã§å‹•çš„ã«æ±ºå®šã•ã‚Œã¾ã™ã€‚
    
# ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦ãªæ¨©é™ã‚’è¨­å®š
permissions:
  contents: write

jobs:
  review_and_commit:
    runs-on: ubuntu-latest
    # UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç’°å¢ƒå…¨ä½“ã§çµ±ä¸€è¨­å®š
    env:
      LANG: ja_JP.UTF-8
      LC_ALL: ja_JP.UTF-8
    
    steps:
      - name: â¬‡ï¸ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          # ãƒ—ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯ã®ãŸã‚ã«èªè¨¼æƒ…å ±ã‚’ä¿æŒ
          persist-credentials: true
          fetch-depth: 0 # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£ç¢ºã«å–å¾—ã™ã‚‹ãŸã‚ã«å±¥æ­´å…¨ä½“ã‚’å–å¾—

      - name: ğŸ”§ Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install google-generativeai pyocr pillow
        
      - name: ğŸ”§ Gitè¨­å®šï¼ˆéASCIIæ–‡å­—ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ç„¡åŠ¹åŒ–ï¼‰
        run: |
          # éASCIIæ–‡å­—ï¼ˆæ—¥æœ¬èªãªã©ï¼‰ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œãªã„ã‚ˆã†ã«è¨­å®š
          git config --global core.quotepath false
        
      - name: ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡æ‹¡å¼µå­ã®èª­ã¿è¾¼ã¿
        id: load-extensions
        run: |
          echo "extensions_pattern<<EOF" >> "$GITHUB_OUTPUT"
          python scripts/load_extensions.py
          echo "EOF" >> "$GITHUB_OUTPUT"
        
      - name: ğŸ” å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®š
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          # å‰å›ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒƒã‚·ãƒ¥ä»¥é™ã®å…¨ã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ã‚’å–å¾—
          since_last_remote_commit: true
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ã‚’è¨­å®šï¼ˆCSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚‚ã®ã®ã¿ï¼‰
          files: |
            ${{ steps.load-extensions.outputs.extensions_pattern }}
            !**/*.d.ts
            !scripts/**
            !docs/**
            !.github/**
            !ocr_outputs/**
            !review/**
          # éASCIIæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹ãŸã‚
          quotepath: false
          # ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å‡ºåŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚„ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œï¼‰
          separator: ","

      - name: "ğŸ” ãƒ‡ãƒãƒƒã‚°: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºåŠ›ç¢ºèª"
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "--- all_changed_files ã®å‡ºåŠ› (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š) ---"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo "------------------------------------"
          echo "ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changed-files.outputs.all_changed_files_count }}"

      - name: ğŸ”§ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å¾©å…ƒå‡¦ç†ï¼ˆPythonï¼‰
        id: decode-files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          python scripts/decode_file_paths.py
        env:
          CHANGED_FILES_RAW: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: ğŸ” å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®š
        id: changed-images
        uses: tj-actions/changed-files@v45
        with:
          # å‰å›ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒƒã‚·ãƒ¥ä»¥é™ã®å…¨ã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ã‚’å–å¾—
          since_last_remote_commit: true
          files: |
            **/*.png
            **/*.jpg
            **/*.jpeg
          quotepath: false
          separator: ","

      - name: ğŸ”§ Tesseractã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.changed-images.outputs.any_changed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-jpn

      - name: ğŸ”„ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®OCRå‡¦ç†
        id: ocr-process
        if: steps.changed-images.outputs.any_changed == 'true'
        run: |
          python scripts/process_ocr.py "${{ steps.changed-images.outputs.all_changed_files }}" ocr_outputs | tee -a "$GITHUB_OUTPUT"

      - name: âš™ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œã¨çµæœã®ä¿å­˜
        id: review_process
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.changed-files.outputs.any_changed == 'true' || steps.changed-images.outputs.any_changed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
          REVIEW_BASE_DIR: review
        run: |
          python scripts/run_reviews.py | tee -a "$GITHUB_OUTPUT"

      - name: ğŸš€ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒ1ã¤ä»¥ä¸Šç”Ÿæˆã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.review_process.outputs.files_to_commit != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat: Geminiã«ã‚ˆã‚‹è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’è¿½åŠ  (${{ github.sha }})'
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒä¿å­˜ã•ã‚ŒãŸ yyyyMMdd ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã‚’ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã¨ã™ã‚‹
          files: ${{ steps.review_process.outputs.files_to_commit }}
          # ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã¨åŒã˜ãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ
          branch: ${{ github.ref_name }} 
          commit_user_name: 'gemini-cli-reviewer[bot]' 
          commit_user_email: 'gemini-cli-reviewer[bot]@users.noreply.github.com'
          skip_ci: true

      - name: ğŸš€ OCRçµæœã®ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
        # OCRçµæœãŒç”Ÿæˆã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.ocr-process.outputs.ocr_output_dir != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®OCRçµæœã‚’è¿½åŠ  (${{ github.sha }})'
          files: ${{ steps.ocr-process.outputs.ocr_output_dir }}
          branch: ${{ github.ref_name }}
          commit_user_name: 'gemini-ocr-processor[bot]'
          commit_user_email: 'gemini-ocr-processor[bot]@users.noreply.github.com'
          skip_ci: true

      - name: ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          rm -f ocr_files_list.txt decoded_files.txt

