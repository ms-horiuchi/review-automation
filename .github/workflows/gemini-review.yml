name: Gemini File-based Review and Commit

on:
  push:
    # å…¨ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¾ã™ã€‚
    # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®ãƒ—ãƒƒã‚·ãƒ¥å…ˆã¯ ${{ github.ref_name }} ã§å‹•çš„ã«æ±ºå®šã•ã‚Œã¾ã™ã€‚
    
# ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦ãªæ¨©é™ã‚’è¨­å®š
permissions:
  contents: write

jobs:
  review_and_commit:
    runs-on: ubuntu-latest
    # UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç’°å¢ƒå…¨ä½“ã§çµ±ä¸€è¨­å®š
    env:
      LANG: ja_JP.UTF-8
      LC_ALL: ja_JP.UTF-8
    
    steps:
      - name: â¬‡ï¸ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          # ãƒ—ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯ã®ãŸã‚ã«èªè¨¼æƒ…å ±ã‚’ä¿æŒ
          persist-credentials: true
          fetch-depth: 0 # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£ç¢ºã«å–å¾—ã™ã‚‹ãŸã‚ã«å±¥æ­´å…¨ä½“ã‚’å–å¾—

      - name: ğŸ”§ Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install google-generativeai
        
      - name: ğŸ”§ Gitè¨­å®šï¼ˆéASCIIæ–‡å­—ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ç„¡åŠ¹åŒ–ï¼‰
        run: |
          # éASCIIæ–‡å­—ï¼ˆæ—¥æœ¬èªãªã©ï¼‰ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œãªã„ã‚ˆã†ã«è¨­å®š
          git config --global core.quotepath false
        
      - name: ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡æ‹¡å¼µå­ã®èª­ã¿è¾¼ã¿
        id: load-extensions
        run: |
          # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ‹¡å¼µå­ã‚’èª­ã¿è¾¼ã‚“ã§file patternsã‚’ç”Ÿæˆ
          echo "extensions_pattern<<EOF" >> "$GITHUB_OUTPUT"
          tail -n +2 docs/target-extensions.csv | tr -d '\r' | while IFS= read -r ext; do
            # ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
            if [ -n "$ext" ]; then
              echo "**/*${ext}" >> "$GITHUB_OUTPUT"
            fi
          done
          echo "EOF" >> "$GITHUB_OUTPUT"
        
      - name: ğŸ” å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®š
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ã‚’è¨­å®š
          files: |
            ${{ steps.load-extensions.outputs.extensions_pattern }}
            !**/*.d.ts
            !scripts/**
          # éASCIIæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹ãŸã‚
          quotepath: false
          # ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å‡ºåŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚„ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œï¼‰
          separator: ","

      - name: "ğŸ” ãƒ‡ãƒãƒƒã‚°: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºåŠ›ç¢ºèª"
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "--- all_changed_files ã®å‡ºåŠ› (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š) ---"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo "------------------------------------"
          echo "ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changed-files.outputs.all_changed_files_count }}"

      - name: ğŸ”§ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å¾©å…ƒå‡¦ç†ï¼ˆPythonï¼‰
        id: decode-files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          python scripts/decode_file_paths.py
        env:
          CHANGED_FILES_RAW: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: âš™ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œã¨çµæœã®ä¿å­˜
        id: review_process
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
          REVIEW_BASE_DIR: review # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¿å­˜ã™ã‚‹ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        run: |
          # GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "Error: GEMINI_API_KEY is not set"
            exit 1
          fi

          # 1. å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ±ºå®šã¨ä½œæˆ (yyyyMMddå½¢å¼ã€æ—¥æœ¬æ™‚é–“)
          REVIEW_DATE_DIR=$(TZ='Asia/Tokyo' date +"%Y%m%d")
          BASE_REVIEW_PATH="${REVIEW_BASE_DIR}/${REVIEW_DATE_DIR}"
          FULL_REVIEW_PATH="$BASE_REVIEW_PATH"
          INDEX=0
          while [ -d "$FULL_REVIEW_PATH" ]; do
            INDEX=$((INDEX + 1))
            FULL_REVIEW_PATH="${BASE_REVIEW_PATH}_${INDEX}"
          done
          echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${FULL_REVIEW_PATH}"
          mkdir -p "$FULL_REVIEW_PATH"

          # 2. å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
          # Pythonã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚€
          if [ ! -f "decoded_files.txt" ]; then
              echo "Error: decoded_files.txt not found"
              exit 1
          fi
          
          # 3. ãƒãƒƒãƒãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œï¼ˆsetup_genaiã€upload_prompt_fileã¯1å›ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
          python scripts/gemini_cli_wrapper.py batch-review docs/instruction-review.md decoded_files.txt "$FULL_REVIEW_PATH" --custom-prompt docs/instruction-review-custom.md
          
          # 4. ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          REVIEW_COUNT=$(find "$FULL_REVIEW_PATH" -type f -name "*.md" 2>/dev/null | wc -l)
          echo "ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $REVIEW_COUNT"
          
          # 5. ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æ¸¡ã™
          if [ "$REVIEW_COUNT" -gt 0 ]; then
              echo "files_to_commit=${FULL_REVIEW_PATH}" >> "$GITHUB_OUTPUT"
          else
              # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒä¸€ã¤ã‚‚ç”Ÿæˆã•ã‚Œãªã‹ã£ãŸå ´åˆã€ç©ºã®æ–‡å­—åˆ—ã‚’è¨­å®šã—ã¦ã‚¹ã‚­ãƒƒãƒ—
              echo "files_to_commit=" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸš€ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒ1ã¤ä»¥ä¸Šç”Ÿæˆã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.review_process.outputs.files_to_commit != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat: Geminiã«ã‚ˆã‚‹è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’è¿½åŠ  (${{ github.sha }})'
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒä¿å­˜ã•ã‚ŒãŸ yyyyMMdd ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã‚’ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã¨ã™ã‚‹
          files: ${{ steps.review_process.outputs.files_to_commit }}
          # ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã¨åŒã˜ãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ
          branch: ${{ github.ref_name }} 
          commit_user_name: 'gemini-cli-reviewer[bot]' 
          commit_user_email: 'gemini-cli-reviewer[bot]@users.noreply.github.com'
          skip_ci: true
